<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Fitness Tracker</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #metrics .metric {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            background-color: #f3f3f3;
        }
    </style>
</head>
<body>
<h1>–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>

<label for="userIdInput">User ID:</label>
<input type="text" id="userIdInput" placeholder="user_0">
<button onclick="startSocket()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
<button onclick="toggleHistory()">üìú –ò—Å—Ç–æ—Ä–∏—è</button>

<div id="metrics"></div>

<!-- –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –±–ª–æ–∫ -->
<div id="historyBlock" style="display:none; margin-top: 20px;">
    <h2>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
    <label>–ù–∞—á–∞–ª–æ:</label>
    <input type="datetime-local" id="startTime">
    <label>–ö–æ–Ω–µ—Ü:</label>
    <input type="datetime-local" id="endTime">
    <button onclick="loadCustomHistory()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>

    <ul id="historyList"></ul>
</div>

<script>
    let socket;
    let preloadedHistory = [];
    let userId = "";
    const metricBlocks = {};

    function startSocket() {
        userId = document.getElementById("userIdInput").value.trim();
        if (!userId) {
            alert("–í–≤–µ–¥–∏—Ç–µ User ID!");
            return;
        }

        const now = Date.now();
        const start = now - 24 * 60 * 60 * 1000;

        fetch(`/api/history?userId=${userId}&startTimestamp=${start}&endTimestamp=${now}`)
            .then(res => res.json())
            .then(data => {
                preloadedHistory = data;
                data.forEach(renderMetric);
            });

        socket = new WebSocket("ws://localhost:8080/ws");
        socket.onopen = () => socket.send(userId);
        socket.onmessage = e => {
            try {
                const data = JSON.parse(e.data);
                renderMetric(data);
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ JSON:", e.data);
            }
        };
    }

    function renderMetric(data) {
        const { timestamp, metric, value } = data;
        const metricsContainer = document.getElementById("metrics");

        if (!metricBlocks[metric]) {
            const block = document.createElement("div");
            block.className = "metric";
            block.id = metric;

            const title = document.createElement("h3");
            title.textContent = `üìä ${metric}`;
            block.appendChild(title);

            const ts = document.createElement("p");
            ts.className = "ts";
            block.appendChild(ts);

            const val = document.createElement("p");
            val.className = "val";
            block.appendChild(val);

            metricsContainer.appendChild(block);
            metricBlocks[metric] = block;
        }

        const block = metricBlocks[metric];
        block.querySelector(".ts").textContent = `üïí ${new Date(Number(timestamp)).toLocaleString()}`;
        block.querySelector(".val").textContent = `üî¢ –ó–Ω–∞—á–µ–Ω–∏–µ: ${value}`;
    }

    function toggleHistory() {
        const block = document.getElementById("historyBlock");
        block.style.display = block.style.display === "none" ? "block" : "none";
        if (block.style.display === "block") {
            displayHistory(preloadedHistory);
        }
    }

    function displayHistory(data) {
        const list = document.getElementById("historyList");
        list.innerHTML = "";
        if (data.length === 0) {
            list.innerHTML = "<li>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</li>";
            return;
        }
        data.forEach(entry => {
            const time = new Date(Number(entry.timestamp)); // üõ†Ô∏è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —è–≤–Ω–æ
            const formatted = isNaN(time) ? "–ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞" : time.toLocaleString();

            const li = document.createElement("li");
            li.textContent = `${entry.metric}: ${entry.value} (${formatted})`;
            list.appendChild(li);
        });
    }

    function loadCustomHistory() {
        const startInput = document.getElementById("startTime").value;
        const endInput = document.getElementById("endTime").value;

        if (!startInput || !endInput) {
            alert("–£–∫–∞–∂–∏—Ç–µ –æ–±–∞ –≤—Ä–µ–º–µ–Ω–∏!");
            return;
        }

        const start = new Date(startInput).getTime();
        const end = new Date(endInput).getTime();

        fetch(`/api/history?userId=${userId}&startTimestamp=${start}&endTimestamp=${end}`)
            .then(res => res.json())
            .then(data => displayHistory(data));
    }
</script>
</body>
</html>
