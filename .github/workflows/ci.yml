name: Java CI Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      zookeeper:
        image: confluentinc/cp-zookeeper:5.5.1
        ports:
          - 32181:32181
        options: >-
          --health-cmd="echo ruok | nc localhost 32181 | grep imok"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        env:
          ZOOKEEPER_CLIENT_PORT: 32181
          ZOOKEEPER_TICK_TIME: 2000

      kafka:
        image: confluentinc/cp-kafka:5.5.1
        ports:
          - 9092:9092
        env:
          KAFKA_BROKER_ID: 1
          KAFKA_ZOOKEEPER_CONNECT: localhost:32181
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
          KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
          KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
        options: >-
          --health-cmd="kafka-topics --bootstrap-server localhost:9092 --list"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission to Maven wrapper
        run: chmod +x mvnw

      - name: Build project
        run: ./mvnw clean install -DskipTests

      - name: Run Spring Boot app in background
        run: |
          nohup ./mvnw spring-boot:run > app.log 2>&1 &
          sleep 30

      - name: Wait for app to be ready
        run: |
          until curl --output /dev/null --silent --head --fail http://localhost:8080; do
            echo "Waiting for Spring Boot to start..."
            sleep 5
          done

      - name: Run tests
        run: ./mvnw test
